{% load static %}

<section id="projects" class="projects section">

  <div class="container section-title" data-aos="fade-up">
    <h2>Projelerimiz</h2>
    <p>Atölyemizden seçtiğimiz bazı çalışmalar.</p>
  </div>

  <div class="container">

    {# Kategoriler varsa filtreleri göster #}
    <div id="project-filters">
      {% include "main/includes/projects_filters.html" with categories=categories only %}
    </div>

    {# Ana sayfada home_projects, sayfa görünümünde projects değişkeni gelir #}
    <div id="projects-grid">
      {% include "main/includes/projects_grid.html" with projects=home_projects|default:projects only %}
    </div>

  </div>

</section>

{# --- AJAX: sadece bu bölümün altına ekle --- #}
<script>
document.addEventListener("DOMContentLoaded", function () {
  const grid = document.getElementById("projects-grid");
  const filters = document.getElementById("project-filters");

  if (!grid || !filters) return;

  // Filtre linklerine tıklandığında sayfa değiştirme; yalnız grid'i yenile
  filters.addEventListener("click", async function(e) {
    const a = e.target.closest("a");
    if (!a) return;

    // Yalnızca kategori linklerini yakala (href=.../projects/?category=...)
    const href = a.getAttribute("href") || "";
    if (!href.includes("{% url 'main:projects' %}")) return;

    e.preventDefault();

    // URL'deki ?category=... paramını al
    const url = new URL(href, window.location.origin);
    const cat = url.searchParams.get("category") || "";

    // Partial endpoint'ini hazırla
    const partial = new URL("{% url 'main:projects_partial' %}", window.location.origin);
    if (cat) partial.searchParams.set("category", cat);

    // Loading efekti
    grid.style.opacity = "0.6";

    try {
      const res = await fetch(partial, {headers: {"X-Requested-With": "fetch"}});
      const html = await res.text();
      grid.innerHTML = html;

      // Adres çubuğunu güncelle (geri/ileri çalışsın)
      const full = new URL("{% url 'main:projects' %}", window.location.origin);
      if (cat) full.searchParams.set("category", cat);
      history.pushState({category: cat}, "", full);

      // Aktif sekmeyi sınıflandır (filter-active)
      // projects_filters.html içinde aktif class'ı server-side veriyorduk;
      // front-end'de de hızlıca güncelleyelim:
      filters.querySelectorAll("a").forEach(x => x.classList.remove("filter-active"));
      a.classList.add("filter-active");
    } finally {
      grid.style.opacity = "1";
    }
  });

  // Back/forward destekle
  window.addEventListener("popstate", async (e) => {
    const cat = (e.state && e.state.category) || (new URL(location.href)).searchParams.get("category") || "";
    const partial = new URL("{% url 'main:projects_partial' %}", window.location.origin);
    if (cat) partial.searchParams.set("category", cat);
    const res = await fetch(partial);
    grid.innerHTML = await res.text();

    // Aktif class
    const activeHrefBase = "{% url 'main:projects' %}";
    filters.querySelectorAll("a").forEach(x => {
      const xurl = new URL(x.getAttribute("href"), window.location.origin);
      const xcat = xurl.searchParams.get("category") || "";
      x.classList.toggle("filter-active", xurl.pathname === activeHrefBase && xcat === cat);
    });
  });
});
</script>
