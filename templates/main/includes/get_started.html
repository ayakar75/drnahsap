<section id="get-started" class="get-started section">
    <div class="container">
        <div class="row justify-content-between gy-4">

            <div class="col-lg-6 d-flex align-items-center" data-aos="zoom-out" data-aos-delay="100">
                <div class="content">
                    <h3>Ücretsiz Keşif ve Teklif Alın</h3>
                    <p>İhtiyacınızı kısaca anlatın; ölçü, tasarım ve malzemeyi birlikte netleştirelim.
                        Özel üretim mutfak, gardırop, kapı ve masif mobilyalarda size en uygun fiyat ve zaman planını
                        hazırlayalım.</p>
                    <p class="mb-0 text-muted small">
                        İpucu: Ölçü, mekân/oda, tarz-renk, teslim zamanı ve bütçe aralığını yazmanız süreci hızlandırır.
                    </p>
                </div>
            </div>

            <div class="col-lg-5" data-aos="zoom-out" data-aos-delay="200">
                <form id="getStartedForm" action="{% url 'main:contact_message_api' %}" method="post"
                      class="gs-email-form">
                    {% csrf_token %}

                    <div style="display:none;" aria-hidden="true">
                        <input type="text" name="honeypot_field" tabindex="-1" autocomplete="off">
                    </div>

                    <h3>Teklif Formu</h3>
                    <p>DRN Ahşap Atölye ekibi en kısa sürede sizinle iletişime geçecektir.</p>

                    <div class="row gy-3">
                        <div class="col-12">
                            <input type="text" name="name" class="form-control" placeholder="Ad Soyad" required>
                        </div>
                        <div class="col-12">
                            <input type="email" class="form-control" name="email" placeholder="E-posta" required>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control" name="phone" placeholder="Telefon" required>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control" name="subject"
                                   placeholder="Konu (örn. Mutfak Dolabı, Gardırop)">
                        </div>
                        <div class="col-12">
                             <textarea class="form-control" name="message" rows="6"
                                       placeholder="Mesajınız (ölçüler, tarz, teslim tarihi, bütçe aralığı…)"
                                       required></textarea>
                        </div>

                        <div class="col-12 text-center">
                            <div class="loading" style="display:none;">Yükleniyor…</div>
                            <div class="error-message" style="display:none; color:red; margin-bottom:10px;"></div>
                            <div class="sent-message" style="display:none; color:green; margin-bottom:10px;">
                                Talebiniz başarıyla gönderildi. Teşekkür ederiz!
                            </div>

                            <button id="gsSubmit" type="submit" class="btn btn-warning"
                                    style="background-color:#f9a825; border:none; color:#fff;">
                                Teklif Al
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<script>
    // CSRF cookie helper
    function getCookie(name) {
        const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return m ? m.pop() : '';
    }

    (function () {
        const form = document.getElementById('getStartedForm');
        if (!form) return;

        const csrftoken = getCookie('csrftoken');
        const loadingEl = form.querySelector('.loading');
        const errorEl = form.querySelector('.error-message');
        const sentEl = form.querySelector('.sent-message');
        const submitBtn = document.getElementById('gsSubmit');

        form.addEventListener('submit', async function (e) {
            e.preventDefault(); // Sayfa yenilenmesini engeller

            if (loadingEl) loadingEl.style.display = 'block';
            if (errorEl) {
                errorEl.style.display = 'none';
                errorEl.textContent = '';
            }
            if (sentEl) sentEl.style.display = 'none';
            if (submitBtn) submitBtn.disabled = true;

            try {
                const resp = await fetch(form.action, {
                    method: 'POST',
                    headers: {'X-CSRFToken': csrftoken},
                    body: new FormData(form)
                });
                const data = await resp.json().catch(() => ({}));

                if (!resp.ok || !data.ok) {
                    const msg = (data.errors && Object.values(data.errors).join(' ')) || 'Gönderim başarısız.';
                    if (errorEl) {
                        errorEl.textContent = msg;
                        errorEl.style.display = 'block';
                    }
                } else {
                    if (sentEl) sentEl.style.display = 'block';
                    form.reset();
                    setTimeout(() => {
                        if (sentEl) sentEl.style.display = 'none';
                    }, 5000);
                }
            } catch (err) {
                if (errorEl) {
                    errorEl.textContent = 'Sunucuya ulaşılamadı. Lütfen daha sonra deneyin.';
                    errorEl.style.display = 'block';
                }
            } finally {
                if (loadingEl) loadingEl.style.display = 'none';
                if (submitBtn) submitBtn.disabled = false;
            }
        });
    })();
</script>