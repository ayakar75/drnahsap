{% extends "main/base.html" %}
{% load static %}

{% block body_class %}services-page{% endblock %}

{% block content %}
    {# 1. SimpleLightbox CSS'i Yerel Olarak Yükle #}
    <link rel="stylesheet" href="{% static 'assets/vendor/simplelightbox/simple-lightbox.min.css' %}"/>

    <div class="page-title dark-background"
         style="background-image: url({% static 'assets/img/services/atolye.png' %});">
        <div class="container position-relative">
            <h1>Hizmetlerimiz</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a href="{% url 'main:home' %}">Anasayfa</a></li>
                    <li class="current">Hizmetlerimiz</li>
                </ol>
            </nav>
        </div>
    </div>

    <section class="section">
        <div class="container">
            <div class="row gy-4 align-items-center">
                <div class="col-lg-6">
                    <img src="{% static 'assets/img/services/atolye.png' %}" alt="Atölye"
                         class="img-fluid rounded-4">
                </div>
                <div class="col-lg-6">
                    <h2 class="mb-3">Özel Ölçü Ahşap Üretimi ve Usta İşçilik</h2>
                    <p class="lead mb-3">
                        Mutfak, banyo, gardırop, kapı ve pergola gibi tüm sabit mobilyalarda
                        <strong>ölçüye özel tasarım</strong>, kaliteli malzeme ve titiz montaj ile hizmet veriyoruz.
                    </p>
                    <ul class="list-unstyled mb-0">
                        <li><i class="bi bi-check-circle me-2"></i> Keşif & ölçü alma, 3D tasarım ve teklif</li>
                        <li><i class="bi bi-check-circle me-2"></i> Üretim, vernik/lake uygulamaları, montaj</li>
                        <li><i class="bi bi-check-circle me-2"></i> Garanti, tadilat ve periyodik bakım</li>
                    </ul>
                </div>
            </div>
        </div>
    </section>

    <section id="alt-services" class="alt-services section">
        <div class="container">
            <div class="row justify-content-around gy-4">
                <div class="features-image col-lg-6">
                    <img src="{% static 'assets/img/services/atolye_ortami.png' %}" alt="Atölye çalışma alanı">
                </div>
                <div class="col-lg-5 d-flex flex-column justify-content-center">
                    <h3>Özel Üretim ve Ana Yetenekler</h3>
                    <p>İhtiyaca göre proje tasarımı yapar, ölçüye uygun üretir ve yerinde montajını
                        gerçekleştiririz.</p>

                    <div class="icon-box d-flex position-relative">
                        <i class="bi bi-rulers flex-shrink-0"></i>
                        <div>
                            <h4>Ölçü & Tasarım</h4>
                            <p>Yerinde keşif, ölçülendirme, 3D/çizim desteği ve malzeme danışmanlığı.</p>
                        </div>
                    </div>

                    <div class="icon-box d-flex position-relative">
                        <i class="bi bi-tools flex-shrink-0"></i>
                        <div>
                            <h4>Üretim & Montaj</h4>
                            <p>CNC kesim, kenar bantlama, gizli bağlantılar ve profesyonel montaj.</p>
                        </div>
                    </div>

                    <div class="icon-box d-flex position-relative">
                        <i class="bi bi-brush flex-shrink-0"></i>
                        <div>
                            <h4>Yüzey İşlemleri</h4>
                            <p>Lake, vernik, yağ ve renklendirme seçenekleri; ipek mat / parlak.</p>
                        </div>
                    </div>

                    <div class="icon-box d-flex position-relative">
                        <i class="bi bi-shield-check flex-shrink-0"></i>
                        <div>
                            <h4>Garanti & Bakım</h4>
                            <p>Montaj sonrası ayar, periyodik bakım ve hızlı tadilat çözümleri.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <div class="section-header text-center">
                <h2>Malzeme ve Yüzey Seçenekleri</h2>
            </div>
            <div class="row gy-4">
                <div class="col-lg-6">
                    <div class="p-4 border rounded-3 h-100">
                        <h5>Gövde / Kapak Malzemeleri</h5>
                        <ul>
                            <li>MDF / MDFLam, Suntalam, Kontrplak</li>
                            <li>Masif panel (meşe, çam vb.), kaplama</li>
                            <li>Nem dayanımlı seçenekler (banyo/mutfak)</li>
                        </ul>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="p-4 border rounded-3 h-100">
                        <h5>Yüzey İşlemleri</h5>
                        <ul>
                            <li>Lake (mat/yarı mat/parlak), ipek mat vernik</li>
                            <li>Doğal yağ, renklendirme, eskitme efektleri</li>
                            <li>Kenar bant: PVC/ABS, gizli/soft detaylar</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="section">
        <div class="container">
            <div class="section-header text-center">
                <h2>Örnek Çalışmalar</h2>
                <p class="text-muted mb-0">Bir vitrin başlığına tıklayın; görseller aşağıda yüklensin.</p>
            </div>

            {% if showcases %}
                <div class="row justify-content-center">
                    <div class="col-lg-10">

                        {% for sc in showcases %}
                            <div class="text-center my-4">
                                <a href="#" class="display-6 text-decoration-none fw-semibold showcase-link"
                                   data-sid="{{ sc.id }}">
                                    {{ sc.name }}
                                </a>
                                {% if sc.total %}
                                    <div class="small text-muted mt-1">({{ sc.total }} görsel)</div>{% endif %}
                            </div>

                            {# HTML DÜZELTİLDİ: data-sid eklendi #}
                            <div id="sc-{{ sc.id }}-gallery" class="row gy-3 simple-gallery"
                                 data-sid="{{ sc.id }}" style="display:none;"></div>

                            <div class="text-center mt-3" id="sc-{{ sc.id }}-more-wrap" style="display:none;">
                                <button class="btn btn-outline-primary btn-sm sc-more-btn" data-sid="{{ sc.id }}">Daha
                                    Fazla Yükle
                                </button>
                            </div>

                            <hr class="my-5">
                        {% endfor %}

                    </div>
                </div>

                {# 2. SimpleLightbox JS'i Yerel Olarak Yükle #}
                <script src="{% static 'assets/vendor/simplelightbox/simple-lightbox.min.js' %}"></script>

                <script>
                    (function () {
                        // state'i vitrin bazında tutalım
                        const state = {}; // {sid: {page, per, loading}}
                        const PER = 12;

                        function elsFor(sid) {
                            return {
                                gal: document.getElementById(`sc-${sid}-gallery`),
                                moreWrap: document.getElementById(`sc-${sid}-more-wrap`),
                                moreBtn: document.querySelector(`.sc-more-btn[data-sid="${sid}"]`)
                            };
                        }

                        async function loadShowcase(sid, reset = false) {
                            if (!state[sid]) state[sid] = {page: 1, per: PER, loading: false};
                            const s = state[sid];
                            if (s.loading) return;
                            s.loading = true;

                            const {gal, moreWrap} = elsFor(sid);
                            try {
                                const url = `{% url 'main:services_showcase_images' 0 %}`.replace('/0/', `/${sid}/`)
                                    + `?page=${s.page}&per=${s.per}`;
                                const resp = await fetch(url);
                                const data = await resp.json();
                                if (!data.ok) throw new Error();

                                if (reset) gal.innerHTML = '';
                                data.images.forEach(img => {
                                    const col = document.createElement('div');
                                    col.className = 'col-6 col-md-4 col-lg-3';

                                    // HTML yapısı
                                    col.innerHTML = `
                      <a href="${img.url}" title="${img.title}">
                        <img src="${img.url}" class="img-fluid rounded-3" alt="${img.title}">
                      </a>`;
                                    gal.appendChild(col);
                                });

                                gal.style.display = '';
                                moreWrap.style.display = data.has_more ? 'block' : 'none';

                                // SimpleLightbox'ı başlat/yenile
                                // Kütüphane yüklenmeme hatası giderildiği için bu kısım artık çalışmalı.
                                new SimpleLightbox(`#sc-${sid}-gallery a`, {
                                    captionAttribute: "title",
                                    navText: ['←', '→'],
                                    closeText: '×',
                                });

                            } catch (e) {
                                console.error(e);
                                gal.innerHTML = '<div class="col-12 text-center text-muted">Görseller yüklenemedi.</div>';
                                gal.style.display = '';
                            } finally {
                                s.loading = false;
                            }
                        }

                        // Başlığa tıklayınca yükle/aç
                        document.querySelectorAll('.showcase-link').forEach(a => {
                            a.addEventListener('click', e => {
                                e.preventDefault();
                                const sid = a.dataset.sid;

                                // Her tıklamada galeriyi temizle ve ilk sayfayı yükle
                                document.querySelectorAll('.simple-gallery').forEach(g => {
                                    const otherSid = g.dataset.sid;

                                    if (otherSid && otherSid !== sid) {
                                        g.style.display = 'none';
                                        g.innerHTML = '';

                                        // Hata veren opsiyonel zincirleme yerine if kontrolü kullanılıyor
                                        const moreWrapElement = document.getElementById(`sc-${otherSid}-more-wrap`);
                                        if (moreWrapElement) {
                                            moreWrapElement.style.display = 'none';
                                        }
                                    }
                                });
                                state[sid] = {page: 1, per: PER, loading: false};
                                loadShowcase(sid, true);
                            });
                        });

                        // Daha fazla yükle
                        document.querySelectorAll('.sc-more-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const sid = btn.dataset.sid;
                                state[sid].page += 1;
                                loadShowcase(sid, false);
                            });
                        });
                    })();
                </script>
            {% else %}
                <p class="text-center text-muted">Henüz vitrin tanımlanmamış.</p>
            {% endif %}
        </div>
    </section>


    <section class="section bg-light">
        <div class="container">
            <div class="section-header text-center">
                <h2>Sık Sorulan Sorular</h2>
            </div>
            <div class="accordion" id="faq">
                {% for qa in faqs %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}"
                                    type="button" data-bs-toggle="collapse" data-bs-target="#faq-{{ forloop.counter }}">
                                {{ qa.q }}
                            </button>
                        </h2>
                        <div id="faq-{{ forloop.counter }}"
                             class="accordion-collapse collapse {% if forloop.first %}show{% endif %}"
                             data-bs-parent="#faq">
                            <div class="accordion-body">{{ qa.a }}</div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <section class="call-to-action section">
        <div class="container">
            <div class="row align-items-center gy-3">
                <div class="col-lg-8">
                    <h3>Projenizi konuşalım</h3>
                    <p class="mb-0">Ölçü, tasarım ve malzeme seçiminde ücretsiz danışmanlık için bize ulaşın.</p>
                </div>
                <div class="col-lg-4 text-lg-end">
                    <a href="{% url 'main:contact' %}" class="btn btn-primary btn-lg">Teklif Al</a>
                </div>
            </div>
        </div>
    </section>
{% endblock %}